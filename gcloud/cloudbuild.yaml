---
images:
  - "gcr.io/experimental-works/blank-api-rails:latest"
  - "gcr.io/experimental-works/blank-api-rails:$SHORT_SHA"
timeout: "5m"
steps:
  -
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "sh"
    args:
      - "-c"
      - "docker pull gcr.io/experimental-works/blank-api-rails:latest || exit 0"
  -
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "sh"
    args:
      - "-c"
      - "bin/docker-cloudbuild"
    env:
      - "SHORT_SHA=$SHORT_SHA"
      - "PROJECT_ID=$PROJECT_ID"
    secretEnv:
      - "RAILS_MASTER_KEY"
      - "POSTGRES_PASSWORD"
secrets:
  -
    kmsKeyName: "projects/experimental-works/locations/global/keyRings/blank-api-rails/cryptoKeys/runtime-secrets"
    secretEnv:
      RAILS_MASTER_KEY: "CiQAjmV6AFe9ciJCynFhShFHMvMmpP4ZviKOO5pkL9p7+eMQrz8SSgDhwJn0MF7aDXEWejthbwEIH0vKHz2AiQqlKXIgi18xsHDJceThMQj7udc9lp5wwH6TMmcX6uM44ErohAe5naayCrkKPeOcK714"
  -
    kmsKeyName: "projects/experimental-works/locations/global/keyRings/blank-api-rails/cryptoKeys/runtime-secrets"
    secretEnv:
      POSTGRES_PASSWORD: "CiQAjmV6AIB4WpOSs878w32fg7X5cnhdkFhnGQffKlu4Eahh0YoSSgDhwJn0ehZ3jgzW+kRaxZuj33xjEhzmouzwEHO5SX0CUVZbj9xBVNpX0Gy/XE6fPLrUFb7qfGs5SaM8HcFQG9OakJp8mr63MSKt"
