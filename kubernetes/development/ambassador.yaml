---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ambassador
  labels:
    service: ambassador
spec:
  replicas: 1
  selector:
    matchLabels:
      service: ambassador
      role: service-mesh
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
        "consul.hashicorp.com/connect-inject": "false"
      labels:
        service: ambassador
        role: service-mesh
    spec:
      restartPolicy: Always
      containers:
        -
          name: ambassador
          image: quay.io/datawire/ambassador:0.50.2
          imagePullPolicy: IfNotPresent
          ports:
            -
              name: http
              containerPort: 80
            -
              name: https
              containerPort: 443
            -
              name: admin
              containerPort: 8877
          env:
            -
              name: STATSD_ENABLED
              value: "true"
            -
              name: AMBASSADOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          livenessProbe:
            httpGet:
              path: /ambassador/v0/check_alive
              port: 8877
            initialDelaySeconds: 30
            periodSeconds: 3
          readinessProbe:
            httpGet:
              path: /ambassador/v0/check_ready
              port: 8877
            initialDelaySeconds: 30
            periodSeconds: 3
---
apiVersion: v1
kind: Service
metadata:
  name: ambassador
  labels:
    service: ambassador
    role: service-mesh
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
   -
     port: 80
  selector:
    service: ambassador
---
apiVersion: v1
kind: Service
metadata:
  name: ambassador-admin
  labels:
    service: ambassador-admin
    role: browser-dashboard
spec:
  type: NodePort
  ports:
    -
      name: ambassador-admin
      port: 8877
      targetPort: 8877
  selector:
    service: ambassador-admin
---
apiVersion: v1
kind: Service
metadata:
  name: ambassador-router
  labels:
    service: ambassador
  annotations:
    getambassador.io/config: |
      ---
      apiVersion: ambassador/v1
      kind:  Mapping
      name:  resource-api
      prefix: /resources/
      service: resource-api.default
      ---
      apiVersion: ambassador/v1
      kind:  Mapping
      name:  kubernetes-dashboard
      prefix: /kubernetes-dashboard/
      service: kubernetes-dashboard.kube-system
      ---
      apiVersion: ambassador/v1
      kind:  Mapping
      name:  grafana
      prefix: /grafana/
      service: grafana.default
      ---
      apiVersion: ambassador/v1
      kind:  Mapping
      name:  metabase
      prefix: /metabase/
      service: metabase.default
spec:
  selector:
    access: external
  ports:
    -
      name: ambassador-router
      port: 80
      targetPort: http
# ---
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: ambassador
#   labels:
#     service: ambassador
# data:
#   exporterConfiguration: |
#     ---
#     mappings:
#       -
#         match: 'envoy.cluster.*.upstream_rq_total'
#         name: "envoy_cluster_upstream_rq_total"
#         timer_type: 'histogram'
#         labels:
#           cluster_name: "$1"
