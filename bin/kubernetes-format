#!/usr/bin/env ruby
require "yaml"
require "fileutils"

Dir[File.join("kubernetes", "production", "**", "*.yaml")].each do |path|
  puts(path)
  tree = YAML.load_stream(File.read(path)).
    reject{|document| document.fetch("metadata").fetch("labels").fetch("group") == "global"}.
    group_by {|document| document.fetch("metadata").fetch("labels").fetch("group")}.
    transform_values {|documents| documents.group_by {|document| document.fetch("kind")}}

  tree.each do |group, grouped_documents|
    FileUtils.mkdir_p(File.join("kubernetes", "production", group))


    grouped_documents.each do |kind, documents|
      `git mv -f #{path} "#{kind}.yaml"`
      # File.write(
      #   File.join("kubernetes", "production", group, "#{kind}.yaml"),
      #   documents.map{|document| YAML.dump(document)}.join("")
      # )
    end
  end
end
